/*** *	zur Verwaltung der Preferences… ***/#include "Preferences.h"#include "StdPrefsLib.h"#include "GlobalLib.h"#include <TextUtils.h>#define kPreferencesFiletype	'PREF'short		prefRefNum;		// RefNum der Preferences/*** *	eine Resource aus den Preferences lesen - wenn vorhanden (sonst wird "nil" zurückgeben) * *	wird als "resId" eine 0 übergeben, so wird eine zufällige resId erzeugt. ***/void		ReadPref(ResType resourceType, short resId, Ptr prefPtr, Size prefSize){	for(int i = 0; i<prefSize; i++)		// Preferences erstmal löschen		prefPtr[i] = 0;	// Preferences schon offen?	if(!prefRefNum) {		if(!PreferencesFileExists(gSignature, kPreferencesFiletype))			return;			// keine Preferences vorhanden => raus		// Preferences öffnen		if(OpenPreferencesFile(gSignature, kPreferencesFiletype, &prefRefNum) != noErr) {			// sind nicht zu öffnen, dann löschen (da wohl defekt)			DeletePreferencesFile(gSignature, kPreferencesFiletype);			return;		}	}	// Preferences Resource lesen	Handle	prefHand;	if(ReadPreference(prefRefNum, resourceType, &resId, &prefHand) == noErr && prefHand) {		BlockMoveData(*prefHand, prefPtr, prefSize);		DisposeHandle(prefHand);	}	// momentan schließen wir die Preferences immer sofort wieder:	ClosePref();}/*** *	eine Resource in den Preferences wegschreiben * *	wird als "resId" eine 0 übergeben, so wird eine zufällige resId erzeugt. ***/void		WritePref(ResType resourceType, short resId, Ptr prefPtr, Size prefSize){Boolean		emptyPref = true;	// sind die Preferences leer (dann nicht speichern, ggf. die Resource sogar wieder löschen)	for(int i=0; i<prefSize; i++) {		if(!prefPtr[i])			continue;		emptyPref = false;		break;	}	// Preferences schon offen? Dann öffnen bzw. ggf. neu erzeugen	if(!prefRefNum) {		Boolean		created = false;		if(!PreferencesFileExists(gSignature, kPreferencesFiletype)) {			if(emptyPref)			// es ist eh nix zu speichern => raus				return;			biene();			Str255		theString;			GetIndString(theString, 4000, 13);	// Namen des Preferences File			if(NewPreferencesFile(gSignature, kPreferencesFiletype, theString, nil, gAppName) != noErr)				return;		// Preferences sind nicht zu erzeugen :-( => raus			created = true;		}		// Preferences öffnen		if(OpenPreferencesFile(gSignature, kPreferencesFiletype, &prefRefNum) != noErr) {			// sind nicht zu öffnen, dann löschen (da wohl defekt)			DeletePreferencesFile(gSignature, kPreferencesFiletype);			return;		}		// Preferences frisch erzeugt?		if(created) {			// dann 'vers' Resourcen in den Preferences erzeugen			NumVersion	numVersion = { 0x01, 0x10, finalStage, 0x00 };			short		regionCode = GetScriptManagerVariable(smRegionCode);			SetPreferencesFileVersion(prefRefNum, kVers1, &numVersion, regionCode, "\p1.1", "\p1.1 (D), ©1994 mastercast");			SetPreferencesFileVersion(prefRefNum, kVers2, &numVersion, regionCode, "\p1.1", "\p(für mastercast)");			pfeil();		}	}	// Preferences Resource wegschreiben	if(!emptyPref) {	// Preferences nicht leer?		Handle		prefHand;		if(PtrToHand(prefPtr, &prefHand, prefSize) == noErr) {			WritePreference(prefRefNum, resourceType, &resId, prefHand);			DisposeHandle(prefHand);		}	} else {		if(resId)		// Preferences ggf. löschen (da eh default)			DeletePreference(prefRefNum, resourceType, resId);	}	// momentan schließen wir die Preferences immer sofort wieder:	ClosePref();}/*** *	Schließen der evtl. offenen Preferences (vor dem Programmende) *	Momentan unnötig, da die Preferences automatisch geschlossen werden. ***/void		ClosePref(void){	// Preferences noch offen?	if(!prefRefNum) {		ClosePreferencesFile(prefRefNum);		prefRefNum = 0;	}}