/*** *	ein paar Hilfsroutinen zu den AppleEvents ***/#include "AEAktion.h"#include "GlobalLib.h"#include "DoEvent.h"#include <Processes.h>AEAddressDesc	gSelfAddress;		// A self-addressed address descriptor record/*** *	Liste der eigenen AppleEvents ***/pascal OSErr	DoAEOpenApplication(const AppleEvent *message,AppleEvent *reply,long refcon);pascal OSErr	DoAEOpenDocuments(const AppleEvent *message,AppleEvent *reply,long refcon);pascal OSErr	DoAEPrintDocuments(const AppleEvent *message,AppleEvent *reply,long refcon);pascal OSErr	DoAEQuitApplication(const AppleEvent *message,AppleEvent *reply,long refcon);OSErr			OpenDocEventHandler(const AppleEvent *message,AppleEvent *reply,short mode);/*** *	AppleEvents anmelden ***/void			InitAppleEvents(void){#if !SystemSevenOrLater	if (!gHasAppleEvents) return;	// Apple Events vorhanden? Nein => raus#endif	ProcessSerialNumber		SelfPSN;				// This application's psn 	SelfPSN.highLongOfPSN = 0; 	SelfPSN.lowLongOfPSN = kCurrentProcess;		//* Use this instead of GetCurrentProcess *//	ThrowIfOSErr_(AECreateDesc(typeProcessSerialNumber,(Ptr)&SelfPSN,sizeof(ProcessSerialNumber),&gSelfAddress));	AEInstallEventHandler(kCoreEventClass, kAEOpenApplication, NewAEEventHandlerProc(DoAEOpenApplication), 0L, false);	AEInstallEventHandler(kCoreEventClass, kAEOpenDocuments, NewAEEventHandlerProc(DoAEOpenDocuments), 0L, false);	AEInstallEventHandler(kCoreEventClass, kAEPrintDocuments, NewAEEventHandlerProc(DoAEPrintDocuments), 0L, false);	AEInstallEventHandler(kCoreEventClass, kAEQuitApplication, NewAEEventHandlerProc(DoAEQuitApplication), 0L, false);}/*** *	Sind irgendwelche unnötigen Parameter vorhanden? ***/static Boolean			MissedAnyParameters(const AppleEvent *message){OSErr		err;DescType	ignoredActualType;AEKeyword	missedKeyword;Size		ignoredActualSize;	err = AEGetAttributePtr(message, keyMissedKeywordAttr, typeKeyword, &ignoredActualType,							(Ptr)&missedKeyword, sizeof(missedKeyword), &ignoredActualSize);	return err != errAEDescNotFound;}/*** *	Applikation wird gestartet, d.h. neues leere Dokument erzeugen ***/#include "MCSelection.h"pascal OSErr	DoAEOpenApplication(const AppleEvent *message,AppleEvent *reply,long refcon){	UNUSED(message); UNUSED(reply); UNUSED(refcon);void			LoadDoc(FSSpecPtr f);	FSSpec		theFSS;	Str255		name;	GetIndString(name, 4000, 14);	if(FSMakeFSSpec(0, 0L, name, &theFSS))	// Testen, ob die Datei bereits existiert		MCSelection::Create();	else		LoadDoc(&theFSS);	return noErr;}/*** *	Übergebene Dokumente öffnen ***/pascal OSErr	DoAEOpenDocuments(const AppleEvent *message,AppleEvent *reply,long refcon){	UNUSED(refcon);	return OpenDocEventHandler(message,reply,0);}/*** *	Übergebene Dokumente drucken ***/pascal OSErr	DoAEPrintDocuments(const AppleEvent *message,AppleEvent *reply,long refcon){	UNUSED(message); UNUSED(reply); UNUSED(refcon);	return errAEEventNotHandled;}/*** *	Quit-Event, Programm beenden ***/pascal OSErr	DoAEQuitApplication(const AppleEvent *message,AppleEvent *reply,long refcon){	UNUSED(message); UNUSED(reply); UNUSED(refcon);	gQuitApplication = true;	return noErr;}/*** *	OpenDocEventHandler * *	gemeinsame Routine für Dokument drucken und Dokument öffnen * *	mode = 0 : normal öffnen *	mode = 1 : zum Drucken öffnen *		 = 2 ***/OSErr			OpenDocEventHandler(const AppleEvent *message,AppleEvent *reply,short mode){OSErr			err;OSErr			err2;AEDesc			theDesc;FSSpec			theFSS;short			loop;long			numFilesToOpen;AEKeyword		iKeyWord;DescType		iType;Size			iSize;void			LoadDoc(FSSpecPtr f);	UNUSED(reply); UNUSED(mode);	if((err = AEGetParamDesc(message,keyDirectObject,typeAEList,&theDesc)) != noErr)		return err;	if(!MissedAnyParameters(message)) {	// Parameter ok?		err = AECountItems(&theDesc, &numFilesToOpen);		if(!err && numFilesToOpen) {			for(loop=1; loop<=numFilesToOpen && !err; loop++) {				err = AEGetNthPtr(&theDesc, loop, typeFSS, &iKeyWord, &iType, (Ptr)&theFSS, sizeof(theFSS), &iSize);				if (err) break;				LoadDoc(&theFSS);			}		}	}	err2 = AEDisposeDesc(&theDesc);	return err ? err : err2;}