/*** *	Portfolio Info ***/#include "MCInfo.h"#include "mc_db.h"#include "MCWindTools.h"#include "MCView.h"#include "MCLayout.h"#include "Utilities.h"#include "PrintSedcard.h"#include "PrintPict.h"#include "GlobalLib.h"#include <string.h>#include <balloons.h>/*** *	Portfolio-Layout Fenster fŸr ein Modell erzeugen ***/void			MCInfo::Create(long mid){MCInfo		*mc = new MCInfo;	mc->Open(mid);}/*** *	MenŸpunkt aufgerufen ***/Boolean			MCInfo::DoCommand(long cmd){	switch(cmd) {	case cPrint:			Boolean		cancel;			if(DialogBase::Do(141) == 1) {				PrintPict	ppict(ModellId, 1, true, cancel);			} else {				PrintSedcard	psed(ModellId, true, cancel);			}			break;	default:			return WindowBase::DoCommand(cmd);	}	return true;}/*** *	Befehle bei Bedarf enablen ***/void			MCInfo::GetCommandStatus(long cmd, Boolean &enabled, short &markChar, Str255 &name){	switch(cmd) {	case cPrint:			enabled = true;			break;	default:			WindowBase::GetCommandStatus(cmd, enabled, markChar, name);	}}/*** *	Info-Fenster šffnen ***/void			MCInfo::Open(long mid){	ModellId = mid;	DialogBase::Open(510);	ModellStruct	*ms;	ms = DB_MGet(ModellId);							// Modell suchen	// die Daten in den Dialog eintragen	DateTimeRec		dtrp;	GetTime(&dtrp);	SText(6, ms->GebJahr?(dtrp.year - ms->GebJahr):0, false);	Str255			stemp;	GetIndString(stemp, 2002, ms->Haare); SetDialogText(8, stemp);	GetIndString(stemp, 2001, ms->Haartyp); SetDialogText(10, stemp);	GetIndString(stemp, 2000, ms->Haarfarbe); SetDialogText(12, stemp);	GetIndString(stemp, 2003, ms->Augenfarbe); SetDialogText(14, stemp);	SText(16, ms->Groesse, true);	SText(18, ms->Brust, true);	SText(20, ms->Taille, true);	SText(22, ms->Huefte, true);	SText(24, ms->Schuhe, false);	SText(26, ms->Hut, false);	SText(28, ms->Ring, false);	// Look	DialogListItem	*dlp = (DialogListItem*)GetObject(30);	if(dlp) dlp->StrToList(2004, ms->Look);	// Besonderheiten	dlp = (DialogListItem*)GetObject(32);	if(dlp) dlp->StrToList(2009, ms->Besonders);	// Geeignet fŸr	dlp = (DialogListItem*)GetObject(34);	if(dlp) dlp->StrToList(2005, ms->Eignung);	// Talente	dlp = (DialogListItem*)GetObject(36);	if(dlp) dlp->StrToList(2006, ms->Talente);	// Sport	dlp = (DialogListItem*)GetObject(38);	if(dlp) dlp->StrToList(2008, ms->Sportarten);	// Sprachen	dlp = (DialogListItem*)GetObject(40);	if(dlp) dlp->StrToList(2010, ms->Sprachen);	// FŸhrerschein	dlp = (DialogListItem*)GetObject(42);	if(dlp) dlp->StrToList(2007, ms->Fuehrerschein);#if 0	// ÒFilm abspielenÓ Button nur sichtbar, wenn ein Film vorhanden ist	if(MovieExist(ModellId))		ShowItem(44);	else		HideItem(44);#endif	Select();	Show();}/*** *	Zahl in Dialogbox einsetzen, ggf. mit "cm" Angabe ***/void		MCInfo::SText(short itemno, long num, Boolean cmflag){Str255		stemp;Str255		Str_cm;	if(num == 0) {								// Angabe fehlt?		stemp[0] = 1; stemp[1] = '?';			// durch ein "?" ersetzen	} else {		NumToString(num, stemp);		if(cmflag) {							// "cm" Einheit anhŠngen?			GetIndString(Str_cm, 4000, 4);			ConcatPString(stemp, Str_cm);		}	}	SetDialogText(itemno, stemp);				// und in das entspr. Textfeld setzen}void		DrawStringAntialiased(Str255 s,Rect *r);#include "OffscreenObject.h"void		DrawStringAntialiased(Str255 s,Rect *r){#define ShrinkFaktor	4		// 4x4 Pixel = 16 Graustufen!	GrafPtr		oldPort;	GetPort(&oldPort);	int		oldTSize = oldPort->txSize;	FontInfo	fi;	GetFontInfo(&fi);	int		oldheight = fi.ascent + fi.descent + fi.leading;	int		oldwidth = StringWidth(s);	TextSize(oldTSize * ShrinkFaktor);	GetFontInfo(&fi);	Rect		rctOff;	SetRect(&rctOff,0,0,StringWidth(s), fi.ascent + fi.descent + fi.leading);	OffscreenObject	qoff(qd.thePort, &rctOff);	if(qoff.Failed()) {		TextSize(oldTSize);		GetFontInfo(&fi);		Move(r->left, r->top + fi.ascent);		DrawString(s);						// String normal ausgeben		return;	}	TextFont(oldPort->txFont);	TextFace(oldPort->txFace);	TextSize(oldTSize * ShrinkFaktor);	MoveTo(r->left, r->top + fi.ascent);	DrawString(s);							// String in die Offscreen-Bitmap ausgeben	r->right = r->left + oldwidth + 2;	r->bottom = r->top + oldheight;	qoff.SetDestRect(r);}/*** *	Info-Fenster darstellen ***/void			MCInfo::Draw(void){Rect		iRect;FontStruct	fonts;	// erstmal die Dialogbox zeichnen	DialogBase::Draw();	ModellStruct	*ms = DB_MGet(ModellId);	// Modell suchen	if(!ms) return;								// Modell nicht gefunden => raus	SaveText(&fonts);							// Zeichensatz-Einstellungen retten	// Namen vom Modell ausgeben	GetItemRect(1, &iRect);	MoveTo(iRect.left, iRect.top + SetFont(1000));			// Zeichensatz, etc. fŸr den Modellnamen setzen	DrawText(ms->Modellname, 0, strlen(ms->Modellname));	// Modellnamen ausgeben//	Str255		theString;//	strcpy((char*)theString, ms->Modellname); C2PStr((char*)theString);//	SetFont(1000); DrawStringAntialiased(theString, &iRect);	// Namen der Agentur ausgeben	GetItemRect(3, &iRect);	MoveTo(iRect.left, iRect.top + SetFont(1001));			// Zeichensatz, etc. fŸr den Agenturnamen setzen	const char	*s = AList?AList->FindId(ms->Agentur)->GetName():"";	DrawText(s, 0, strlen(s));					// Agenturnamen ausgeben//	SetFont(1001); DrawStringAntialiased((StringPtr)s, &iRect);	RestoreText(&fonts);						// Zeichensatz-Einstellungen zurŸcksetzen	// das Headsheet-Bild des Modells ausgeben	GetItemRect(4, &iRect);	DrawPic(ModellId, 1, iRect, true, false);}/*** *	ein Klick auf einen Button ***/void		MCInfo::Button(short button){ModellStruct	*ms;Str63			a,b,c,d;	switch(button) {	case 4:		// Headsheet-Bild des Modells		MCView		*ww = new MCView;		ww->Open(ModellId, 1);					// Headsheet-Bild im View darstellen		break;	case 43:	// ÒAgentur InfoÓ		ms = DB_MGet(ModellId);		// Modell suchen		if(!ms || !AList) return;		Agentur	*ap = AList->FindId(ms->Agentur);		strcpy((char*)a, ap->GetName()); C2PStr((char*)a);		strcpy((char*)b, ap->GetStrasse()); strcat((char*)b, "\r"); strcat((char*)b, ap->GetOrt()); C2PStr((char*)b);		strcpy((char*)c, ap->GetTelefon()); C2PStr((char*)c);		strcpy((char*)d, ap->GetTelefon()); C2PStr((char*)d);		ParamText(a,b,c,d);		DialogBase::Do(133);		break;	case 44:	// Bilder anzeigen		MCLayout::Create(ModellId);#if 0		// Film abspielen		Rect		iRect;		GetItemRect(44, &iRect);		iRect.bottom = iRect.top;		LocalToGlobal(&botRight(iRect));		MoviePlay(ModellId, true, botRight(iRect));#endif		break;	}}/*** *	Default-Mauszeiger fŸr die Fenster setzen * *	Hier: Balloon Help setzen ***/void		MCInfo::MausMoved(Point thePoint, RgnHandle *mouseRgn){GrafPtr			savePort;static short	LastBalloon = 0;	UNUSED(mouseRgn);	if(!gBalloonHelp) return;			// Balloon Help nicht vorhanden => raus	GetPort(&savePort);	SetPort((WindowPtr)WindRef);	GlobalToLocal(&thePoint);	int	dItem = FindDialogItem((DialogPtr)WindRef, thePoint) + 1;	SetPort(savePort);	if(!dItem || !HMGetBalloons()) {	// Ÿber keinem Item oder Balloon Help aus?		LastBalloon = 0;				// => Variable entsprechend zurŸcksetzen		return;							// Balloon Help ist aus => raus	}	if(!HMIsBalloon())					// kein Balloon sichtbar?		LastBalloon = 0;				// => Variable entsprechend zurŸcksetzen	if(LastBalloon == dItem) return;	// Item unverŠndert?	GetPort(&savePort);	SetPort((WindowPtr)WindRef);	// Help-Message aus der hdlg-Resource extrahieren	HMMessageRecord	aHelpMsg;	if(HMExtractHelpMsg(kHMDialogResType, 510, dItem, kHMEnabledItem, &aHelpMsg) != noErr)		return;							// kein Hilfetext vorhanden => raus	Rect		theRect;	GetItemRect(dItem, &theRect);		// Rechteck des Items ermitteln	LocalToGlobalRect(&theRect);	// Maus-Punkt in die Mitte des Items setzen	Point		mousePos;	SetPt(&mousePos, theRect.left + ((theRect.right - theRect.left) >> 1), theRect.top + ((theRect.bottom - theRect.top) >> 1));	// Balloon darstellen	if(HMShowBalloon(&aHelpMsg, mousePos, &theRect, nil, 0, 0, kHMRegularWindow) == noErr)		LastBalloon = dItem;			// aktuelles Item merken	SetPort(savePort);}